<!DOCTYPE html>
<html>
  <head>
    <title>SignExchange</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <!-- <script src="libraries/jquery/jquery-1.11.1.js"></script> -->
    <script src="https://cdn.icecomm.io/icecomm.js"></script>
    <style>
      @import url("libraries/font-awesome/font-awesome.css");
      @import url("libraries/font-awesome/macset.css");

      @font-face {
        font-family: Fira;
        src: url('libraries/font-awesome/FiraSans-Light.ttf');
      }
      @font-face {
        font-family: Lato;
        src: url('libraries/font-awesome/Lato-Light.ttf');
      }

      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      body {
        font-family: "Lato", sans-serif;
        font-weight: 300;
      }

      a, .pointer {
        cursor: pointer;
      }

      a {
        text-decoration: none;
      }

      /* Grid */
      .cams {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 250px;
        overflow-x: hidden;
        overflow-y: auto;
      }
      video, img {
        display: block;
        width: 100%;
        height: auto;
      }

      /* Textbox/Button Styles */
      button, .button {
        border: 0;
        box-sizing: border-box;
        padding: 15px;
        vertical-align: middle;
        line-height: 46px;
        min-height: 40px;
        font-size: 16px;
        margin: 0;
      }

      .red {
        background: #CC6565;
        color: #fff;
      }
      .red:hover {
        background: #E28383;
      }
      .green {
        background: #659459;
        color: #fff;
      }
      .green:hover {
        background: #86B779;
      }

      /* Conversation Area */
      .conversation {
        position: absolute;
        top: 47px;
        left: 250px;
        right: 0;
        bottom: 0;
        overflow: auto;
        list-style: none;
        padding: 0;
      }
      .conversation, li {
        margin: 0;
      }
      .textfill {
        position: absolute;
        top: 0;
        left: 250px;
        right: 96px;
      }
      .message {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 40px;
        resize: none;
      }
      .send {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0 30px;
        line-height: 45px;
      }
      .msgsent {
        padding: 10px;
        margin: 3em;
        /* font-family: "Lato", sans-serif; */
        font-family: "Fira", sans-serif;
        font-size: 16px;
      }
      .theirmsg {
        background: #E8E8E8;
        color: #000;
        text-align: center;
      }
      .theirdate {
        color: #8F8F9E;
      }
      .mymsg {
        background: #0072D0;
        color: #fff;
        text-align: center;
      }
      .mydate {
        color: #95ABCB;
      }
      .date {
        font-size: 10px;
        font-family: "Lato", sans-serif;
      }

      /*Username Dialog*/
      .username-dialog {
        position: absolute;
        top: 0;
        left: 0;
        display: table;
        width: 100%;
        height: 100%;
        color: #fff;
        text-align: center;
        overflow: hidden;
        z-index: 3;
        background: #4CA8E0;
        background: rgba(92, 167, 222, 0.68);
        /*background: rgba(0, 159, 255, 0.58);*/
      }
      .username-dialog nav {
        display: table-cell;
        vertical-align: middle;
      }
      .username {
        font-size: 18px;
        resize: none;
      }
      .setname {
        font-weight: 100;
        padding: 5px 19px;
        position: relative;
        top: 1px;
        background: #0072D0;
      }

      /* Misc */
      .fl {
        float: left;
      }
      .fn {
        float: none;
      }
      .fr {
        float: right;
      }
      .tl {
        text-align: left;
      }
      .tr {
        text-align: right;
      }
      .block {
        display: block;
      }
      .ib {
        display: inline-block;
      }
      .hide {
        display: none;
      }

      .delete-cam, .delete-msg {
        padding: 3px 6px;
        border-radius: 1em;
        font-size: 15px;
        z-index: 2;
      }
      .delete-cam {
        position: relative;
        top: 28px;
        right: 3px;
        float: right;
      }
      .delete-msg {
        margin-top: -7px;
      }

      @media all and (max-width:800px) {
        /* Grid */
        .cams {
          top: 46px;
          height: 150px;
          width: 100%;
          background: #fff;
          z-index: 1;
          overflow-x: auto;
          overflow-y: hidden;
        }
        video, img {
          height: 150px;
          display: inline-block;
          width: auto;
        }

        /* Conversation Area */
        .conversation {
          top: 196px;
          left: 0;
        }
        .textfill {
          position: absolute;
          top: 0;
          left: 0;
          right: 96px;
        }
        .delete-cam {
          top: -128px;
          right: 26px;
          float: none;
        }
        .msgsent {
          margin: 0 2em 2em 2em;
        }
      }
    </style>
  </head>
  <body>
    <header class="username-dialog">
      <nav>
        <h1>
        	<input type="text" class="username" placeholder="Your display name..." />
          <a class="button setname pointer">Confirm</a>
        </h1>
      </nav>
    </header>

    <div class="cams fl">
      <span class="yourcam">
        <video id="localVideo" muted autoplay></video>
      </span>
      <span class="theircam">

      </span>
    </div>

    <form action="#" onSubmit="return false;" id="chatForm">
      <div class="textfill">
        <input type="text" id="m" class="message" name="text" id="text" placeholder="Type what you want to say here..." autocomplete="off">
      </div>
      <input type="submit" name="submit" class="button green send pointer" value="Post">
    </form>

    <ul class="conversation" id="messages"></ul>

    <script>
      var socket = io();
      var counter = 0;
      $('#m').keypress(function(e) {
        if (e.which === 13) {
          if ($('#m').val() === '') {
            $('#m').val('');
            console.log('no text');
          } else {
            socket.emit('chat message',  $(".username").val() + ': ' + $('#m').val());
            $('#m').val('');
            console.log('Message sent');
          }
          return false;
        }
      });
      $('#chatForm').submit(function() {
        socket.emit('chat message',  $(".username").val() + ': ' + $('#m').val());
        $('#m').val('');
        return false;
      });
      var connectIcecomm = function() {
        var comm = new Icecomm('YtoBlRFKwWtjbXQCeDoJ7R3RYx4SKd8aRsZrxyj3OIF9be');

        comm.connect("ASLRoom", {audio: false});

        comm.on('connected', function(peer) {
          $(".theircam").prepend(peer.getVideo());
          $("#" + peer.ID).addClass("deleteCam " + peer.ID);
          $('#messages').prepend($('<li>').addClass('msgsent theirmsg tl block').append('<span class="theirdate date block">a user joined the room<a class="delete-msg red fr">X</a></span> </li>'));

          $(".deleteCam").on("click", function(e) {
            var x;
            if (confirm("Are you sure you wish to delete this webcam? There's no going back!") == true) {
              $("#" + e.target.id).remove();
            }
            document.getElementById("demo").innerHTML = x;
            return false;
          });
        });
        comm.on('local', function(peer) {
          localVideo.src = peer.stream;
        });

        comm.on('disconnect', function(peer) {
          $("#" + peer.ID + ", ." + peer.ID).remove();
          $('#messages').prepend($('<li>').addClass('msgsent theirmsg tl block').append('<span class="theirdate date block">a user left the room<a class="delete-msg red fr">X</a></span> </li>'));
        });
      };
      connectIcecomm();

      // Date
      var currentTime = new Date();
      var month = currentTime.getMonth() + 1;
      var date = currentTime.getDate();
      var year = currentTime.getFullYear();

      socket.on('new chat message', function(msg) {
        var now = new Date();
        // $('#messages').prepend($('<li>').text(msg));
        // $('#messages').prepend($('<li>').addClass('msgsent mymsg tl block').html(msg +'<span class="mydate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'</span> </li>'));
        // $('#messages').prepend($('<li>').addClass('msgsent theirmsg tr block').html(msg +'<span class="theirdate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'</span> </li>'));
        $('#messages').prepend($('<li>').addClass('msgsent theirmsg tl block').text(msg).append('<span class="theirdate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'<a class="delete-msg red fr">X</a></span> </li>'));

        // <li class="msgsent mymsg tl block"> How you say, "How are you?" <span class="mydate date block">Today at 7:30 PM</span> </li>
        // <li class="msgsent theirmsg tr block"> How you say, "My name is?" <span class="theirdate date block">Today at 7:36 PM</span> </li>
        deleteMessage();
      });
      socket.on('ready', function(msg) {
        console.log('this is the room name', msg);
        connectIcecomm(msg);
      });

      var deleteMessage = function() {
        $(".delete-msg").on("click", function() {
          $(this).parent().parent().remove();
          return false;
        });
        return false;
      };

      $(".setname").click(function() {
        if ( $(".username").val() === "" ) {
          alert("You must set a username!");
        } else {
          $(".username-dialog").fadeOut();
        }
      });

      $(".username").keypress(function(e) {
        if ( e.which == 13 ) {
          $(".setname").click();
        }
      });
    </script>
  </body>
</html>
