<!DOCTYPE html>
<html>
  <head>
    <title>SignExchange</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <!-- <script src="libraries/jquery/jquery-1.11.1.js"></script> -->
    <script src="https://cdn.icecomm.io/icecomm.js"></script>
    <style>
      @import url("libraries/font-awesome/font-awesome.css");
      @import url("libraries/font-awesome/macset.css");

      @font-face {
        font-family: Fira;
        src: url('libraries/font-awesome/FiraSans-Light.ttf');
      }
      @font-face {
        font-family: Lato;
        src: url('libraries/font-awesome/Lato-Light.ttf');
      }

      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      body {
        font-family: "Lato", sans-serif;
        font-weight: 300;
      }

      a, .pointer {
        cursor: pointer;
      }

      a {
        text-decoration: none;
      }

      /* Grid */
      .cams {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        width: 250px;
        overflow: auto;
      }
      video, img {
        display: block;
        width: 100%;
        float: none;
      }

      /* Textbox/Button Styles */
      button, .button {
        border: 0;
        box-sizing: border-box;
        padding: 15px;
        vertical-align: middle;
        line-height: 46px;
        min-height: 40px;
        font-size: 16px;
        margin: 0;
      }

      .red {
        background: #CC6565;
        color: #fff;
      }
      .red:hover {
        background: #E28383;
      }
      .green {
        background: #659459;
        color: #fff;
      }
      .green:hover {
        background: #86B779;
      }

      /* Conversation Area */
      .conversation {
        position: absolute;
        top: 25px;
        left: 250px;
        right: 0;
        bottom: 0;
        overflow: auto;
        list-style: none;
      }
      .conversation, li {
        margin: 0;
      }
      .textfill {
        position: absolute;
        top: 0;
        left: 250px;
        right: 96px;
      }
      .message {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 40px;
        resize: none;
      }
      .send {
        position: absolute;
        top: 0;
        right: 0;
        padding: 0 30px;
        line-height: 45px;
      }
      .msgsent {
        padding: 10px;
        margin: 3em;
        /* font-family: "Lato", sans-serif; */
        font-family: "Fira", sans-serif;
        font-size: 16px;
      }
      .theirmsg {
        background: #E8E8E8;
        color: #000;
        text-align: center;
      }
      .theirdate {
        color: #8F8F9E;
      }
      .mymsg {
        background: #0072D0;
        color: #fff;
        text-align: center;
      }
      .mydate {
        color: #95ABCB;
      }
      .date {
        font-size: 10px;
        font-family: "Lato", sans-serif;
      }

      /* Misc */
      .fl {
        float: left;
      }
      .fn {
        float: none;
      }
      .fr {
        float: right;
      }
      .tl {
        text-align: left;
      }
      .tr {
        text-align: right;
      }
      .block {
        display: block;
      }
      .ib {
        display: inline-block;
      }
      .hide {
        display: none;
      }

      .delete-cam, .delete-msg {
        padding: 3px 6px;
        border-radius: 1em;
        font-size: 15px;
        z-index: 999;
      }
      .delete-cam {
        position: relative;
        top: 28px;
        right: 3px;
        float: right;
      }
      .delete-msg {
        margin-top: -7px;
      }

      @media all and (max-width:800px) {
        /* Grid */
        .cams {
          top: 46px;
          height: 150px;
          width: 100%;
          background: #fff;
          z-index: 1;
        }
        video, img {
          width: 200px;
          display: inline-block;
          float: left;
        }

        /* Conversation Area */
        .conversation {
          top: 164px;
          left: 0;
        }
        .textfill {
          position: absolute;
          top: 0;
          left: 0;
          right: 96px;
        }
        .delete-cam {
          top: 8px;
          right: 26px;
          float: none;
        }
        .msgsent {
          margin: 2em;
        }
      }
    </style>
  </head>
  <body>
    <div class="cams">
      <div class="yourcam">
        <video id="localVideo" muted autoplay></video>
      </div>
      <div class="theircam">

      </div>
    </div>

    <form action="#" onSubmit="return false;" id="chatForm">
      <div class="textfill">
        <input type="text" id="m" class="message" name="text" id="text" placeholder="Type what you want to say here..." autocomplete="off">
      </div>
      <input type="submit" name="submit" class="button green send pointer" value="Post">
    </form>

    <ul class="conversation" id="messages">
      <!-- <li class="msgsent mymsg tl block">
        How you say, "How are you?"
        <span class="mydate date block">Today at 7:30 PM
          <a class="delete red fr">
            X
          </a>
        </span>
      </li>
      <li class="msgsent theirmsg tr block">
        How you say, "My name is?"
        <span class="theirdate date block">Today at 7:36 PM
          <a class="delete red fr">
            X
          </a>
        </span>
      </li> -->
      <!-- <li class="msgsent theirmsg tl block">
        How you say, "My name is?"
        <span class="theirdate date block">Today at 7:36 PM
          <a class="delete-msg red fr">
            X
          </a>
        </span>
      </li> -->
    </ul>

    <script>
      var socket = io();
      $(window).keypress(function(e) {
        if (e.keyCode === 13) {
          if ($('#m').val() === '') {
            $('#m').val('');
            console.log('no text');
          } else {
            socket.emit('chat message', $('#m').val());
            $('#m').val('');
            console.log('Message sent');
          }
          return false;
        }
      });
      $('form').submit(function(){
        socket.emit('chat message', $('#m').val());
        $('#m').val('');
        return false;
      });
      var connectIcecomm = function() {
        var comm = new Icecomm('YtoBlRFKwWtjbXQCeDoJ7R3RYx4SKd8aRsZrxyj3OIF9be');

        comm.connect("ASLRoom", {audio: false});

        comm.on('connected', function(peer) {
          $(".theircam").prepend(peer.getVideo());
          $(".theircam").prepend('<a class="delete-cam red" id="'+ peer.ID +'">X</a>');
          deleteCam();
        });

        comm.on('local', function(peer) {
          localVideo.src = peer.stream;
        });

        comm.on('disconnect', function(peer) {
          document.getElementById(peer.ID).remove();
        });
      };
      connectIcecomm();

      // Date
      var currentTime = new Date();
      var month = currentTime.getMonth() + 1;
      var date = currentTime.getDate();
      var year = currentTime.getFullYear();

      socket.on('new chat message', function(msg) {
        var now = new Date();
        // $('#messages').prepend($('<li>').text(msg));
        // $('#messages').prepend($('<li>').addClass('msgsent mymsg tl block').html(msg +'<span class="mydate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'</span> </li>'));
        // $('#messages').prepend($('<li>').addClass('msgsent theirmsg tr block').html(msg +'<span class="theirdate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'</span> </li>'));
        $('#messages').prepend($('<li>').addClass('msgsent theirmsg tl block').html(msg +'<span class="theirdate date block">'+ month + '/' + date + '/' + year + ' ' + now.toLocaleTimeString() +'<a class="delete-msg red fr">X</a></span> </li>'));

        // <li class="msgsent mymsg tl block"> How you say, "How are you?" <span class="mydate date block">Today at 7:30 PM</span> </li>
        // <li class="msgsent theirmsg tr block"> How you say, "My name is?" <span class="theirdate date block">Today at 7:36 PM</span> </li>
        deleteMessage();
      });
      socket.on('ready', function(msg) {
        console.log('this is the room name', msg);
        connectIcecomm(msg);
      });

      var deleteMessage = function() {
        $(".delete-msg").on("click", function() {
          $(this).parent().parent().remove();
          return false;
        });
        return false;
      };
      var deleteCam = function() {
        $(".delete-cam").on("click", function() {
          $(this).next().remove();
          $(this).remove();
          return false;
        });
        return false;
      };
      deleteCam();
      deleteMessage();
    </script>
  </body>
</html>
